<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Secondary Collections &mdash; MapDB</title>
    
    <link rel="stylesheet" href="../_static/sphinx13.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="MapDB" href="../index.html" />
    <link rel="up" title="MapDB Manual" href="index.html" />
    <link rel="next" title="Transactions" href="transactions.html" />
    <link rel="prev" title="HTreeMap" href="htreemap.html" />
  
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>
    <script type="text/javascript">
      // intelligent scrolling of the sidebar content
      $(window).scroll(function() {
        var sb = $('.sphinxsidebarwrapper');
        var win = $(window);
        var sbh = sb.height();
        var offset = $('.sphinxsidebar').position()['top'];
        var wintop = win.scrollTop();
        var winbot = wintop + win.innerHeight();
        var curtop = sb.position()['top'];
        var curbot = curtop + sbh;
        // does sidebar fit in window?
        if (sbh < win.innerHeight()) {
          // yes: easy case -- always keep at the top
          sb.css('top', $u.min([$u.max([0, wintop - offset - 10]),
                                $(document).height() - sbh - 200]));
        } else {
          // no: only scroll if top/bottom edge of sidebar is at
          // top/bottom edge of window
          if (curtop > wintop && curbot > winbot) {
            sb.css('top', $u.max([wintop - offset - 10, 0]));
          } else if (curtop < wintop && curbot < winbot) {
            sb.css('top', $u.min([winbot - sbh - offset - 20,
                                  $(document).height() - sbh - 200]));
          }
        }
      });
    </script>

<!-- google analytics-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42074659-1', 'auto');
  ga('send', 'pageview');

</script>

  
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.post-list-style-disc {list-style-type: disc;}
    ul.post-list-style-none {list-style-type: none;}
    ul.post-list-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body role="document">
<div class="pageheader">
  <ul>
    <li><a href="../index.html">Home</a></li>
    <li><a href="getting-started.html">Intro</a></li>
    <li><a href="index.html">Docs</a></li>
    <li><a href="/blog.html">Blog</a></li>
    <li><a href="https://github.com/jankotek/mapdb">Github</a></li>
  </ul>
  <div>
    <a href="../index.html">
      <img src="../_static/logo.png" alt="MapDB" />
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="transactions.html" title="Transactions"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="htreemap.html" title="HTreeMap"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Home</a>&nbsp;|</li>
        <li><a href="../contents.html">Documentation</a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">MapDB Manual</a> &raquo;</li> 
      </ul>
    </div>
    <div class="document">
    <div class="documentwrapper">
        <div class="bodywrapper">
            <div class="body" role="main">
                
  <div class="section" id="secondary-collections">
<h1>Secondary Collections<a class="headerlink" href="#secondary-collections" title="Permalink to this headline">¶</a></h1>
<p>Rational databases have a very good system of primary and secondary
indexes, tables and views. It has clear benefits for extensibility,
clarity and robustness. On the other hand, it has limitations for scalability
and performance. MapDBs Secondary Collections are <em>poor man`s</em> SQL
tables. It brings the most benefits without sacrificing flexibility.</p>
<p>Secondary Collections are a very simple and flexible way to access and
expand primary collections. Primary collection is an authoritative source
of data, and is modified by the user. Secondary collection contains records
derived from the primary. Secondary is bind to primary and updated by a
listener, when the primary collection is modified. The secondary should not be
modified directly by a user.</p>
<p>Secondary Collections are typically used in three ways:</p>
<ul class="simple">
<li>Secondary Keys (indexes) to efficiently access records in primary
collection.</li>
<li>Secondary Values to expand primary collection, while keeping primary
small and fast.</li>
<li>Aggregation to groups. For example in order to list all high-income customers.</li>
</ul>
<p>The Primary Collection is typically stored in MapDB. The requirement is that
it provides <a class="reference external" href="http://www.mapdb.org/apidocs/org/mapdb/Bind.MapWithModificationListener.html">modification
listener</a>
triggered on entry update, insert or removal. There is no such
requirement for the Secondary Collection. The Secondary may be stored in MapDB,
but it can also be a usual Java Collection such as java.util.TreeSet.</p>
<p>Primary and Secondary collections are bind together. There is
<a class="reference external" href="http://www.mapdb.org/apidocs/org/mapdb/Bind.html">Bind</a> class with
static methods to establish binding. Binding adds a modification listener
to the primary collection and changes secondary collection accordingly. It
also removes old entries from the secondary, if the primary entry gets deleted or
modified.</p>
<p>Bind relation is not persistent, so binding needs to be restored every
time the store is reopened. If the secondary collections is empty when binded,
then the entire primary is traversed and the secondary is filled accordingly.</p>
<div class="section" id="consistency">
<h2>Consistency<a class="headerlink" href="#consistency" title="Permalink to this headline">¶</a></h2>
<p>The consistency between primary and secondary collections are on a
&#8216;best-effort&#8217; basis. The secondary map might contain an old value,
while the primary map was already updated. Also if two maps are part of two different transactions,
and one transaction get rolled back but second transaction is commited,
the secondary map will become inconsistent with the primary
(its changes were not rolled back.</p>
<p>The secondary collection is updated in <a class="reference external" href="https://en.wikipedia.org/wiki/Serializability">serializable
fashion</a>. This means
that if two concurrent threads update primary, the secondary collection is
updated with &#8216;winner&#8217;. TODO verify this is true, update this paragraph
after <a class="reference external" href="https://github.com/jankotek/MapDB/issues/226">issue</a> is
closed.</p>
<p>There are some best practices for Secondary Collections to handle this:</p>
<ul class="simple">
<li>Secondary Collections must be thread safe. Either use MapDB or
<code class="docutils literal"><span class="pre">java.util.concurrent.*</span></code> collections. Another
option is to use <code class="docutils literal"><span class="pre">Collections.synchronized*()</span></code> wrappers.</li>
<li>When using concurrent transactions, do not mix the collections from
multiple transactions. If the primary gets rollback, the secondary will not
be updated if its not within the same transaction.</li>
<li>Keep binding minimal. It should only transform one value into the other,
without dependency on third collections.</li>
</ul>
</div>
<div class="section" id="performance">
<h2>Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h2>
<p>To import a large dataset, you should not enable binding until the primary
collection has finished its import. Also, there might be a more efficient
way to pre-fill the secondary collection (for example with a data pump).</p>
</div>
</div>

  <div class="section">
  
  
  </div>


                <br><br><br><hr><br> 
                <div id="disqus_thread"></div>
                <script>

if(window.location.href.indexOf('/blog/')>-1){

/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//mapdb.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();

}
</script>

            </div>
        </div>
    </div>

    <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="transactions.html" title="Transactions"
             >next</a> |</li>
        <li class="right" >
          <a href="htreemap.html" title="HTreeMap"
             >previous</a> |</li>
        <li><a href="../index.html">Home</a>&nbsp;|</li>
        <li><a href="../contents.html">Documentation</a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >MapDB Manual</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, Jan Kotek.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>