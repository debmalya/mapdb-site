<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>HTreeMap &mdash; MapDB</title>
    
    <link rel="stylesheet" href="../_static/sphinx13.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="MapDB" href="../index.html" />
    <link rel="up" title="MapDB documentation" href="index.html" />
    <link rel="next" title="MapDB internals" href="internals.html" />
    <link rel="prev" title="BTreeMap" href="btreemap.html" />
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>
    <script type="text/javascript">
      // intelligent scrolling of the sidebar content
      $(window).scroll(function() {
        var sb = $('.sphinxsidebarwrapper');
        var win = $(window);
        var sbh = sb.height();
        var offset = $('.sphinxsidebar').position()['top'];
        var wintop = win.scrollTop();
        var winbot = wintop + win.innerHeight();
        var curtop = sb.position()['top'];
        var curbot = curtop + sbh;
        // does sidebar fit in window?
        if (sbh < win.innerHeight()) {
          // yes: easy case -- always keep at the top
          sb.css('top', $u.min([$u.max([0, wintop - offset - 10]),
                                $(document).height() - sbh - 200]));
        } else {
          // no: only scroll if top/bottom edge of sidebar is at
          // top/bottom edge of window
          if (curtop > wintop && curbot > winbot) {
            sb.css('top', $u.max([wintop - offset - 10, 0]));
          } else if (curtop < wintop && curbot < winbot) {
            sb.css('top', $u.min([winbot - sbh - offset - 20,
                                  $(document).height() - sbh - 200]));
          }
        }
      });
    </script>

<!-- google analytics-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42074659-1', 'auto');
  ga('send', 'pageview');

</script>

  </head>
  <body role="document">
<div class="pageheader">
  <ul>
    <li><a href="../index.html">Home</a></li>
    <li><a href="getting-started.html">Intro</a></li>
    <li><a href="index.html">Docs</a></li>
    <li><a href="https://github.com/jankotek/mapdb">Github</a></li>
  </ul>
  <div>
    <a href="../index.html">
      <img src="../_static/logo.png" alt="MapDB" />
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="internals.html" title="MapDB internals"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="btreemap.html" title="BTreeMap"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Home</a>&nbsp;|</li>
        <li><a href="../contents.html">Documentation</a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">MapDB documentation</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">HTreeMap</a><ul>
<li><a class="reference internal" href="#parameters">Parameters</a></li>
<li><a class="reference internal" href="#entry-expiration-parameters">Entry expiration parameters</a></li>
<li><a class="reference internal" href="#concurrent-scalability">Concurrent scalability</a></li>
<li><a class="reference internal" href="#compared-to-btreemap">Compared to BTreeMap</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="btreemap.html"
                        title="previous chapter">BTreeMap</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="internals.html"
                        title="next chapter">MapDB internals</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/doc/htreemap.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="htreemap">
<h1>HTreeMap<a class="headerlink" href="#htreemap" title="Permalink to this headline">¶</a></h1>
<p>HTreeMap provides <code class="docutils literal"><span class="pre">HashMap</span></code> and <code class="docutils literal"><span class="pre">HashSet</span></code>.
It has great performance with large keys.
It also offers entry expiration based on size or time-to-live</p>
<p>HTreeMap is <em>segmented Hash Tree</em>. Most hash collections use hash table based in fixed size array,
when it becomes full, all data has to be moved and rehashed into
new bigger table. HTreeMap uses auto-expandind Hash Treestructure, so it never needs resizing.
It also occupies less space, since empty hash slots do not consume any space.
On other side tree structure requries more seeks and is slower on access.
Its performance degrades with size, but maximal has dir node size is 255,
so degradation is very small.
TODO performance degradation depending on size. Probably  log N.</p>
<p>To achieve parallel scalability HTreeMap is split into 16  segments,
each with separate read-write lock. <code class="docutils literal"><span class="pre">ConcurrentHashMap</span></code> in JDK 7 works similar
way. Number of segments (also called concurrency scale) is hard wired
into design and can not be changed.
Because all segments share underlying storage, concurrent scalability is not perfect.
Other option is to create each segment with separate storage.</p>
<p>HTreeMap optionally supports entry expiration based on four criteria:
maximal map size, time-to-live since last modification and time-to-live
since last access. Expired entries are automatically removed. This
feature uses FIFO queue, each segment has independent expiration queue.
Priority per entry can not be set.</p>
<div class="section" id="parameters">
<h2>Parameters<a class="headerlink" href="#parameters" title="Permalink to this headline">¶</a></h2>
<p>HTreeMap has number of parameters to tune its performance. Number of
segments (aka concurrency factor) is hard-coded to16 and can not be
changed. Other params can be set only when map is created and can not be
changed latter.</p>
<p>Most important are probably <strong>serializers</strong>. General serialization has
some guessing and overhead, so it always has better performance to use
more specific serializers. To specify key and value serializer use code
bellow. There are dozens ready to use serializers available as static
fields on <code class="docutils literal"><span class="pre">Serializer</span></code> interface:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">HTreeMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">hashMapCreate</span><span class="o">(</span><span class="s">&quot;map&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">keySerializer</span><span class="o">(</span><span class="n">Serializer</span><span class="o">.</span><span class="na">STRING</span><span class="o">)</span>
        <span class="o">.</span><span class="na">valueSerializer</span><span class="o">(</span><span class="n">Serializer</span><span class="o">.</span><span class="na">LONG</span><span class="o">)</span>
        <span class="o">.</span><span class="na">makeOrGet</span><span class="o">();</span>
</pre></div>
</div>
<p>HTreeMap is recommended for handling large key/values. In same cases you
may want to use compression. Enabling compression store-wide is not
always best, since constantly (de)compressing index tree has overhead.
Instead it is better to apply compression just to specific serializer on key or value.
This is done by using serializer wrapper:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">HTreeMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">hashMapCreate</span><span class="o">(</span><span class="s">&quot;map&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">valueSerializer</span><span class="o">(</span><span class="k">new</span> <span class="n">Serializer</span><span class="o">.</span><span class="na">CompressionWrapper</span><span class="o">(</span><span class="n">Serializer</span><span class="o">.</span><span class="na">STRING</span><span class="o">))</span>
        <span class="o">.</span><span class="na">makeOrGet</span><span class="o">();</span>

<span class="c1">//TODO add Serializer.compressed() method?</span>
</pre></div>
</div>
<p>Most hash maps uses 32bit hash generated by <code class="docutils literal"><span class="pre">Object.hashCode()</span></code> and check equality with <code class="docutils literal"><span class="pre">Object.equals(other)</span></code>.
However many classes do not implement those functions correctly, and inconsistent hashing is
very bad for persistence, it could cause data loss.
In default configuration HTreeMap uses generic key serializer and relies on those methods as well,
however it throws an exception, if inconsitent hashing is detected. TODO exception name</p>
<p>If specialized Key Serializer is defined, HTreeMap relies on it to provide hash code and equality check
for keys. For example <code class="docutils literal"><span class="pre">Serializer.BYTE_ARRAY</span></code> uses TODO link to <code class="docutils literal"><span class="pre">java.util.Arrays.hashCode(byte[])</span></code>.
This way you can use primitive arrays directly as a key/value without a wrapper.
Bypassing wrappers such as <code class="docutils literal"><span class="pre">String</span></code> improves performance:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">HTreeMap</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[],</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">hashMapCreate</span><span class="o">(</span><span class="s">&quot;map&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">keySerializer</span><span class="o">(</span><span class="n">Serializer</span><span class="o">.</span><span class="na">BYTE_ARRAY</span><span class="o">)</span>
        <span class="o">.</span><span class="na">makeOrGet</span><span class="o">();</span>
</pre></div>
</div>
<p>Other parameter is <strong>size counter</strong>. By default HTreeMap does not keep
track of its size, calling <code class="docutils literal"><span class="pre">map.size()</span></code> requires linear scan to count
all entries. You can enable size counter, in that case
<code class="docutils literal"><span class="pre">map.size()</span></code> is instant, but there is some overhead on inserts.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">HTreeMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">hashMapCreate</span><span class="o">(</span><span class="s">&quot;map&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">counterEnable</span><span class="o">()</span>
        <span class="o">.</span><span class="na">makeOrGet</span><span class="o">();</span>
</pre></div>
</div>
<p>And finally some sugar. There is <strong>value creator</strong>, a function to create
value if existing value is not found. Newly created value is inserted
into map. This way <code class="docutils literal"><span class="pre">map.get(key)</span></code> never returns null. This is mainly
useful for various generators and caches.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">HTreeMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">hashMapCreate</span><span class="o">(</span><span class="s">&quot;map&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">valueCreator</span><span class="o">(</span><span class="k">new</span> <span class="n">Fun</span><span class="o">.</span><span class="na">Function1</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Long</span> <span class="nf">run</span><span class="o">(</span><span class="n">String</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="mi">1111L</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">makeOrGet</span><span class="o">();</span>
</pre></div>
</div>
<p>or more readable version in Java 8:</p>
<div class="code java highlight-python"><div class="highlight"><pre>HTreeMap&lt;String,Long&gt; map = db.createHashMap(&quot;map&quot;)
        .valueCreator((key)-&gt; 1111L)
        .makeOrGet();

// this way map.get() returns 1111L if no value is found
map.get(&quot;aa&quot;); // 1111L
map.get(&quot;bb&quot;); // 1111L

// map now contains [&quot;aa&quot;-&gt;1111L, &quot;bb&quot;-&gt;1111L]
</pre></div>
</div>
</div>
<div class="section" id="entry-expiration-parameters">
<h2>Entry expiration parameters<a class="headerlink" href="#entry-expiration-parameters" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">HTreeMap</span></code> offers optional entry expiration if some conditions are
met. Entry can expire if:</p>
<ul class="simple">
<li>Number of entries in map would exceed maximal size</li>
<li>Entry exist in map longer time than expiration period is. The
expiration period could be since last modification or since last read
access.</li>
<li>Disk/memory space consumed by Map is bigger then some limit in GB.</li>
</ul>
<p>There is shortcut in <code class="docutils literal"><span class="pre">DBMaker</span></code> to quickly use <code class="docutils literal"><span class="pre">HTreeMap</span></code> as off-heap
cache with memory size limit:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// Off-heap map with max size 16GB</span>
<span class="n">Map</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">DBMaker</span>
        <span class="o">.</span><span class="na">newCacheDirect</span><span class="o">(</span><span class="mi">16</span><span class="o">);</span>
</pre></div>
</div>
<p>This equals to <code class="docutils literal"><span class="pre">expireStoreSize</span></code> param:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">HTreeMap</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">createHashMap</span><span class="o">(</span><span class="s">&quot;cache&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">expireStoreSize</span><span class="o">(</span><span class="mi">128</span><span class="o">)</span>
        <span class="o">.</span><span class="na">makeOrGet</span><span class="o">();</span>
</pre></div>
</div>
<p>It is also possible to limit maximal size of map:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">HTreeMap</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">hashMapCreate</span><span class="o">(</span><span class="s">&quot;cache&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">expireMaxSize</span><span class="o">(</span><span class="mi">128</span><span class="o">)</span>
        <span class="o">.</span><span class="na">makeOrGet</span><span class="o">();</span>
</pre></div>
</div>
<p>And finally you can set expiration time since last modification or since
last access.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="c1">// remove entries 1H after their last modification, or 10 minutes after last get()</span>
<span class="n">HTreeMap</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">hashMapCreate</span><span class="o">(</span><span class="s">&quot;cache&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">expireAfterAccess</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">HOURS</span><span class="o">)</span>
        <span class="o">.</span><span class="na">expireAfterWrite</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">)</span>
        <span class="o">.</span><span class="na">makeOrGet</span><span class="o">();</span>
</pre></div>
</div>
<p>TODO expiration counts are approximate. Map size can go slightly over limits for short period of time.</p>
<p>TODO disk space limit has issues. Investigate how it works and document</p>
<p>TODO expiration threads single and multithreaded.</p>
</div>
<div class="section" id="concurrent-scalability">
<h2>Concurrent scalability<a class="headerlink" href="#concurrent-scalability" title="Permalink to this headline">¶</a></h2>
<p>HTreeMap scales concurrently by using 16 separate segment, each with its own <code class="docutils literal"><span class="pre">ReadWriteLock</span></code>.
Each segment has its own independent state, hash tree and also expiration queue.
But all segments still share underlying storage and are limited by its performance.</p>
<p>There is option to shard HTreeMap. Each separate segment can get its own storage, so no shared
state exist between segments. This way one get linear concurrent scalability which corresponds
to 16 segments. TODO benchmarks.</p>
<p>Trade off in this case is higher memory consumption. There are 16 different stores, each with its own
memory allocator and unused blocks. TODO memory benchmarks.
But each store can be compacted separately. TODO add compaction doc for this</p>
<p>TODO example construct storage</p>
</div>
<div class="section" id="compared-to-btreemap">
<h2>Compared to BTreeMap<a class="headerlink" href="#compared-to-btreemap" title="Permalink to this headline">¶</a></h2>
<p><cite>HTreeMap</cite> has major advantage over <cite>BTreeMap</cite> with large keys. Unlike
BTreeMap it only stores hash codes in tree nodes.
BTreeMap deserializes tree nodes together with their keys on each lookup.
Simple <code class="docutils literal"><span class="pre">BTreeMap.get(key)</span></code> could deserialize houndreds of keys.</p>
<p>TODO link to performance test, compare with BTreeMap</p>
<p>On other side HTreeMap has limited concurrency factor to 16, so with
writes it wont scale over 4 CPU cores. It uses read-write locks, so read
operations are not affected. However in practice disk IO is more likely
to be bottleneck. TODO benchmarks</p>
<p>HTreeMap can be easily sharded by segments. For in-memory map it might have better
concurrent scalability.</p>
<p>HTreeMap is simpler than BTreeMap. It has more predictable performance over long time
and does not get fragmented after frequent deletes.
HTreeMap also offers expiration.
BTreeMap pays tax in some cases for its complex lock-free design.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="internals.html" title="MapDB internals"
             >next</a> |</li>
        <li class="right" >
          <a href="btreemap.html" title="BTreeMap"
             >previous</a> |</li>
        <li><a href="../index.html">Home</a>&nbsp;|</li>
        <li><a href="../contents.html">Documentation</a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="index.html" >MapDB documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, Jan Kotek.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>