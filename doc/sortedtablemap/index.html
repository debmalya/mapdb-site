<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Sorted Table Map &mdash; MapDB</title>
    
    <link rel="stylesheet" href="../../_static/sphinx13.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="MapDB" href="../../" />
    <link rel="up" title="MapDB Manual" href="../" />
    <link rel="next" title="Performance and durability" href="../performance/" />
    <link rel="prev" title="BTreeMap" href="../btreemap/" />
  
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>
    <script type="text/javascript">
      // intelligent scrolling of the sidebar content
      $(window).scroll(function() {
        var sb = $('.sphinxsidebarwrapper');
        var win = $(window);
        var sbh = sb.height();
        var offset = $('.sphinxsidebar').position()['top'];
        var wintop = win.scrollTop();
        var winbot = wintop + win.innerHeight();
        var curtop = sb.position()['top'];
        var curbot = curtop + sbh;
        // does sidebar fit in window?
        if (sbh < win.innerHeight()) {
          // yes: easy case -- always keep at the top
          sb.css('top', $u.min([$u.max([0, wintop - offset - 10]),
                                $(document).height() - sbh - 200]));
        } else {
          // no: only scroll if top/bottom edge of sidebar is at
          // top/bottom edge of window
          if (curtop > wintop && curbot > winbot) {
            sb.css('top', $u.max([wintop - offset - 10, 0]));
          } else if (curtop < wintop && curbot < winbot) {
            sb.css('top', $u.min([winbot - sbh - offset - 20,
                                  $(document).height() - sbh - 200]));
          }
        }
      });
    </script>

<!-- google analytics-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42074659-1', 'auto');
  ga('send', 'pageview');

</script>

  
  <link rel="alternate" type="application/atom+xml"  href="../../blog/atom.xml" title="MapDB Blog">
  
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body role="document">
<div class="pageheader">
  <ul>
    <li><a href="../../">Home</a></li>
    <li><a href="../quick-start/">Quick start</a></li>
    <li><a href="../">Docs</a></li>
    <li><a href="../../blog/">Blog</a></li>
      <li><a href="../../support/">Support</a></li>

      <li><a href="https://github.com/jankotek/mapdb">Github</a></li>
  </ul>
  <div>
    <a href="../../">
      <img src="../../_static/logo.png" alt="MapDB" />
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../performance/" title="Performance and durability"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="../btreemap/" title="BTreeMap"
             accesskey="P">previous</a> |</li>
        <li><a href="../../">Home</a>&nbsp;|</li>

          <li class="nav-item nav-item-1"><a href="../" accesskey="U">MapDB Manual</a> &raquo;</li> 
      </ul>
    </div>
<div class="sphinxsidebar" role="navigation" aria-label="main navigation">
    <div class="sphinxsidebarwrapper">
  <h3><a href="../../">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Sorted Table Map</a><ul>
<li><a class="reference internal" href="#binary-search">Binary search</a></li>
<li><a class="reference internal" href="#parameters">Parameters</a></li>
<li><a class="reference internal" href="#volume">Volume</a></li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><div class="sitemap">
    <h3>Site Map</h3>
    <ul>
        <li><a href="/support/">Support</a></li>
        <li><a href="/blog/">Blog</a></li>
        <li><a href="/success/">Who is using MapDB</a></li>
        <li><a href="/benchmarks/">Benchmarks</a></li>
        <li><a href="/changelog/">Changelog</a></li>
        <li><a href="/credits/">Credits</a></li>
        <!--<li><a href="/careers/">Careers</a></li>-->

        <li><a href="/doc/">Documentation</a><ul>
            <li><a href="/doc/intro/">Intro</a></li>
            <li><a href="/doc/quick-start/">Quick start</a></li>
            <li><a href="/doc/db/">DB and DBMaker</a></li>
            <li><a href="/doc/htreemap/">HTreeMap</a></li>
            <li><a href="/doc/btreemap/">BTreeMap</a></li>
            <li><a href="/doc/sortedtablemap/">Sorted Table Map</a></li>
        </ul></li>
        <li><a href="/dokka/latest/mapdb/org.mapdb/">Dokka</a></li>
        <li><a href="/javadoc/latest/mapdb">Javadoc</a></li>
    </ul>

    <h3>Links</h3>
    <ul>
        <li><a href="https://www.github.com/jankotek/mapdb/">Github</a>
        <li><a href="https://www.github.com/jankotek/mapdb/issues/">Issue tracker</a>
        <li><a href="https://groups.google.com/forum/#!forum/mapdb">Mail list</a></li>
        <li><a href="https://www.reddit.com/r/mapdb">Reddit forum</a></li>
        <li><a href="https://gitter.im/jankotek/mapdb">Gitter chat</a></li>
    </ul>
</div>
    </div>
</div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="sorted-table-map">
<h1>Sorted Table Map<a class="headerlink" href="#sorted-table-map" title="Permalink to this headline">Â¶</a></h1>
<p><code class="docutils literal"><span class="pre">SortedTableMap</span></code> is inspired by Sorted String Tables from Cassandra.
It stores keys in file (or memory store) in fixed size table, and uses binary search.
There are some tricks to support variable-length entries and to decrease space usage.
Compared to <code class="docutils literal"><span class="pre">BTreeMap</span></code> it is faster, has zero fragmentation, but is readonly.</p>
<p><code class="docutils literal"><span class="pre">SortedTableMap</span></code> is read-only and does not support updates.
Changes should be applied by creating new Map with Data Pump.
Usually one places change into secondary map,
and periodically merges two maps into new <code class="docutils literal"><span class="pre">SortedTableMap</span></code>.</p>
<p><code class="docutils literal"><span class="pre">SortedTableMap</span></code> is read-only. Its created and filled with content by Data Pump and Consumer:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="c1">//create memory mapped volume</span>
<span class="n">Volume</span> <span class="n">volume</span> <span class="o">=</span> <span class="n">MappedFileVol</span><span class="p">.</span><span class="n">FACTORY</span><span class="p">.</span><span class="n">makeVolume</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

<span class="c1">//open consumer which will feed map with content</span>
<span class="n">SortedTableMap</span><span class="p">.</span><span class="n">Sink</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">sink</span> <span class="o">=</span>
        <span class="n">SortedTableMap</span><span class="p">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">volume</span><span class="p">,</span>
                <span class="n">Serializer</span><span class="p">.</span><span class="n">INTEGER</span><span class="p">,</span>
                <span class="n">Serializer</span><span class="p">.</span><span class="n">STRING</span>
        <span class="p">).</span><span class="n">createFromSink</span><span class="p">();</span>

<span class="c1">//feed content into consumer</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">key</span><span class="o">&lt;</span><span class="mi">100000</span><span class="p">;</span> <span class="n">key</span><span class="o">++</span><span class="p">){</span>
    <span class="n">sink</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;value&quot;</span><span class="o">+</span><span class="n">key</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// finally open created map</span>
<span class="n">SortedTableMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">sink</span><span class="p">.</span><span class="n">create</span><span class="p">();</span>
</pre></div>
</div>
<p>Once file is created, it can be reopened:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="c1">//open existing  memory-mapped file in read-only mode</span>
<span class="n">Volume</span> <span class="n">volume</span> <span class="o">=</span> <span class="n">MappedFileVol</span><span class="p">.</span><span class="n">FACTORY</span><span class="p">.</span><span class="n">makeVolume</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
                                                         <span class="c1">//read-only=true</span>

<span class="n">SortedTableMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span>
        <span class="n">SortedTableMap</span><span class="p">.</span><span class="n">open</span><span class="p">(</span>
                <span class="n">volume</span><span class="p">,</span>
                <span class="n">Serializer</span><span class="p">.</span><span class="n">INTEGER</span><span class="p">,</span>
                <span class="n">Serializer</span><span class="p">.</span><span class="n">STRING</span>
                <span class="p">);</span>
</pre></div>
</div>
<div class="section" id="binary-search">
<h2>Binary search<a class="headerlink" href="#binary-search" title="Permalink to this headline">Â¶</a></h2>
<p>Storage is split into <cite>pages</cite>. Page size is power of two, with maximal size 1MB. First key on each page is stored on-heap.</p>
<p>Each page contains several nodes composed of keys and values. Those are very similar to BTreeMap Leaf nodes.
Node offsets are known, so fast seek to beginning of node is used.</p>
<p>Each node contains several key-value pairs (by default 32). Their organization depends on serializer, but typically
are compressed together (delta compression, LZF..) to save space. So to find single entry, one has to load/traverse
entire node. Some fixed-lenght serializer (Serializer.LONG...) do not have to load entire node to find single entry.</p>
<p>Binary search on <code class="docutils literal"><span class="pre">SortedTableMap</span></code> is performed in three steps:</p>
<ul class="simple">
<li>First key for each page is stored on-heap in an array. So perform binary search to find page.</li>
<li>First key on each node can by loaded without decompressing entire node.
So perform binary search over first keys on each node</li>
<li>Now we know node, so perform binary search over node keys. This depends on Serializer.
Usually entire node is loaded, but other options are possible <cite>TODO link to serializer binary search</cite>.</li>
</ul>
</div>
<div class="section" id="parameters">
<h2>Parameters<a class="headerlink" href="#parameters" title="Permalink to this headline">Â¶</a></h2>
<p><code class="docutils literal"><span class="pre">SortedTableMap</span></code> takes key <strong>serializer</strong> and value serializers. The keys and values are stored together inside
Value Array <cite>TODO link to serializers</cite>. They can be compressed together to save space.
Serializer is trade-off between space usage and performance.</p>
<p>Another setting is <strong>Page Size</strong>. Default and maximal value is 1MB. Its value must be power of two, other valuaes
are rounded up to nearest power of two. Smaller value typically means faster access. But for each page
one key is stored on-heap, smaller Page Size also means larger memory usage.</p>
<p>And finally there is <strong>Node Size</strong>. It has similar implications as BTreeMap node size. Larger node
means better compression, since large chunks are better compressible. But it also means slower access times,
since more entries are loaded to get single entry. Default node size is 32 entries, it should be lowered for large values.</p>
<p>Parameters are set following way</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="c1">//create memory mapped volume</span>
<span class="n">Volume</span> <span class="n">volume</span> <span class="o">=</span> <span class="n">MappedFileVol</span><span class="p">.</span><span class="n">FACTORY</span><span class="p">.</span><span class="n">makeVolume</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

<span class="c1">//open consumer which will feed map with content</span>
<span class="n">SortedTableMap</span><span class="p">.</span><span class="n">Sink</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">sink</span> <span class="o">=</span>
        <span class="n">SortedTableMap</span><span class="p">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">volume</span><span class="p">,</span>
                <span class="n">Serializer</span><span class="p">.</span><span class="n">INTEGER</span><span class="p">,</span> <span class="c1">// key serializer</span>
                <span class="n">Serializer</span><span class="p">.</span><span class="n">STRING</span>   <span class="c1">// value serializer</span>
        <span class="p">)</span>
                <span class="p">.</span><span class="n">pageSize</span><span class="p">(</span><span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span> <span class="c1">// set Page Size to 64KB</span>
                <span class="p">.</span><span class="n">nodeSize</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>       <span class="c1">// set Node Size to 8 entries</span>
                <span class="p">.</span><span class="n">createFromSink</span><span class="p">();</span>

<span class="c1">//feed content into consumer</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">key</span><span class="o">&lt;</span><span class="mi">100000</span><span class="p">;</span> <span class="n">key</span><span class="o">++</span><span class="p">){</span>
    <span class="n">sink</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&quot;value&quot;</span><span class="o">+</span><span class="n">key</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// finally open created map</span>
<span class="n">SortedTableMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">sink</span><span class="p">.</span><span class="n">create</span><span class="p">();</span>
<span class="n">volume</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>

<span class="c1">// Existing SortedTableMap can be reopened.</span>
<span class="c1">// In that case only Serializers needs to be set,</span>
<span class="c1">// other params are stored in file</span>
<span class="n">volume</span> <span class="o">=</span> <span class="n">MappedFileVol</span><span class="p">.</span><span class="n">FACTORY</span><span class="p">.</span><span class="n">makeVolume</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
                                                     <span class="c1">// read-only=true</span>
<span class="n">map</span> <span class="o">=</span> <span class="n">SortedTableMap</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">volume</span><span class="p">,</span> <span class="n">Serializer</span><span class="p">.</span><span class="n">INTEGER</span><span class="p">,</span> <span class="n">Serializer</span><span class="p">.</span><span class="n">STRING</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="volume">
<h2>Volume<a class="headerlink" href="#volume" title="Permalink to this headline">Â¶</a></h2>
<p><code class="docutils literal"><span class="pre">SortedTableMap</span></code> does not use <code class="docutils literal"><span class="pre">DB</span></code> object, but operates directly on <code class="docutils literal"><span class="pre">Volume</span></code> (MapDB abstraction over ByteBuffer).
Following example show how to construct various <code class="docutils literal"><span class="pre">Volume</span></code> using in-memory byte array or memory-mapped file:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="c1">//create in-memory volume over byte[]</span>
<span class="n">Volume</span> <span class="n">byteArrayVolume</span> <span class="o">=</span> <span class="n">ByteArrayVol</span><span class="p">.</span><span class="n">FACTORY</span><span class="p">.</span><span class="n">makeVolume</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

<span class="c1">//create in-memory volume in direct memory using DirectByteByffer</span>
<span class="n">Volume</span> <span class="n">offHeapVolume</span> <span class="o">=</span> <span class="n">ByteBufferMemoryVol</span><span class="p">.</span><span class="n">FACTORY</span><span class="p">.</span><span class="n">makeVolume</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

<span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="n">File</span><span class="p">.</span><span class="n">createTempFile</span><span class="p">(</span><span class="s">&quot;mapdb&quot;</span><span class="p">,</span><span class="s">&quot;mapdb&quot;</span><span class="p">);</span>
<span class="c1">//create memory mapped file volume</span>
<span class="n">Volume</span> <span class="n">mmapVolume</span> <span class="o">=</span> <span class="n">MappedFileVol</span><span class="p">.</span><span class="n">FACTORY</span><span class="p">.</span><span class="n">makeVolume</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">getPath</span><span class="p">(),</span> <span class="nb">false</span><span class="p">);</span>

<span class="c1">//or if data were already imported, create it read-only</span>
<span class="n">mmapVolume</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="n">mmapVolume</span> <span class="o">=</span> <span class="n">MappedFileVol</span><span class="p">.</span><span class="n">FACTORY</span><span class="p">.</span><span class="n">makeVolume</span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">getPath</span><span class="p">(),</span> <span class="nb">true</span><span class="p">);</span>
                                                                  <span class="c1">//read-only=true</span>
</pre></div>
</div>
<p>Volume is than passed to <code class="docutils literal"><span class="pre">SortecTableMap</span></code> factory method as an parameter. It is recommended to open existing
Volumes in read-only mode (last param is <code class="docutils literal"><span class="pre">true</span></code>) to minimize file locking and simplify your code.</p>
<p>Data Pump sync Volume content to disk, so file based <code class="docutils literal"><span class="pre">SortedTableMap</span></code> is durable once the <code class="docutils literal"><span class="pre">Consumer.finish()</span></code>
method exits</p>
</div>
</div>

  <div class="section">
  
  
  </div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../performance/" title="Performance and durability"
             >next</a></li>
        <li class="right" >
          <a href="../btreemap/" title="BTreeMap"
             >previous</a> |</li>
        <li><a href="../../">Home</a>&nbsp;|</li>

          <li class="nav-item nav-item-1"><a href="../" >MapDB Manual</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, jan.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>