<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Transactions &mdash; MapDB</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="MapDB" href="../index.html" />
    <link rel="up" title="MapDB documentation" href="index.html" />
    <link rel="next" title="What for?" href="what-for.html" />
    <link rel="prev" title="Durability and speed" href="durability-versus-speed.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="what-for.html" title="What for?"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="durability-versus-speed.html" title="Durability and speed"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">MapDB</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">MapDB documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <p>DB and DBMaker
==============q</p>
<p>MapDB is set of loosely coupled components. One could wire classes such
as <tt class="docutils literal"><span class="pre">CacheMRU</span></tt>, <tt class="docutils literal"><span class="pre">StoreWAL</span></tt> and <tt class="docutils literal"><span class="pre">BTreeMap</span></tt> manually, byt there are
two factory classes to do it for you: <tt class="docutils literal"><span class="pre">DBMaker</span></tt> and <tt class="docutils literal"><span class="pre">DB</span></tt>. They use
maker (builder) pattern, so most configuration options are quickly
available via code assistant in IDE.</p>
<p><a class="reference external" href="apidocs/org/mapdb/DBMaker.html">DBMaker</a> handles database
configuration, creation and opening. MapDB has several modes and
configuration options. Most of those can be set using this class.</p>
<p><a class="reference external" href="apidocs/org/mapdb/DB.html">DB</a> represents opened database (or single
transaction session). It creates and opens collections . It also handles
transaction with methods such as <tt class="docutils literal"><span class="pre">commit()</span></tt>, <tt class="docutils literal"><span class="pre">rollback()</span></tt> and
<tt class="docutils literal"><span class="pre">close()</span></tt>.</p>
<p>To open (or create) store use one of <tt class="docutils literal"><span class="pre">DBMaker.newXXX()</span></tt> static
methods. MapDB has more formats and modes, each <tt class="docutils literal"><span class="pre">newXXX()</span></tt> uses
different: <tt class="docutils literal"><span class="pre">newMemoryDB()</span></tt> opens in-memory database backed by
<tt class="docutils literal"><span class="pre">byte[]</span></tt>, <tt class="docutils literal"><span class="pre">newAppendFileDB()</span></tt> opens db which uses append-only log
files and so on.</p>
<p><tt class="docutils literal"><span class="pre">newXXX()</span></tt> method is followed by configuration options and <tt class="docutils literal"><span class="pre">make()</span></tt>
method which applyes all options and returns <tt class="docutils literal"><span class="pre">DB</span></tt> object. This example
opens file storage with encryption enabled:</p>
<div class="code java highlight-python"><div class="highlight"><pre>DB db = DBMaker
  .newAppendFileDB(new File(&quot;/some/file&quot;))
  .encryptionEnable(&quot;password&quot;)
  .make();
</pre></div>
</div>
<p>Once you have DB you may open collection or other record. DB has two
types of factory methods:</p>
<p><tt class="docutils literal"><span class="pre">getXXX()</span></tt> opens existing collection (or record). If collection with
given name does not exist, it is silently created with default settings
and returned. An example:</p>
<div class="code java highlight-python"><div class="highlight"><pre>NavigableSet treeSet = db.getTreeSet(&quot;treeSet&quot;);
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">createXXX()</span></tt> creates new collection (or settings) with customized
settings. Specialized serializers, node size, entry compression and so
on affect performance a lot and they are customizable here.</p>
<div class="code java highlight-python"><div class="highlight"><pre>Atomic.Var&lt;Person&gt; var = = db.createAtomicVar(&quot;mainPerson&quot;, Person.SERIALIZER);
</pre></div>
</div>
<p>Some <tt class="docutils literal"><span class="pre">create</span></tt> method may use builder style configuration. In that case
you may finish with two methods: <tt class="docutils literal"><span class="pre">make()</span></tt> creates new collection, if
collection with given name already exists it throws an exception.
<tt class="docutils literal"><span class="pre">makerOrGet()</span></tt> is same, except if collection already exist it does not
fail, but returns existing collection.</p>
<div class="code java highlight-python"><div class="highlight"><pre>NavigableSet&lt;String&gt; treeSet = db.createTreeSet(&quot;treeSet);
  .nodeSize(112)
  .serializer(BTreeKeySerializer.STRING)
  .makeOrGet();
</pre></div>
</div>
<div class="section" id="transactions">
<h1>Transactions<a class="headerlink" href="#transactions" title="Permalink to this headline">Â¶</a></h1>
<p><tt class="docutils literal"><span class="pre">DB</span></tt> has methods to handle transaction lifecycle: <tt class="docutils literal"><span class="pre">commit()</span></tt>,
<tt class="docutils literal"><span class="pre">rollback()</span></tt> and <tt class="docutils literal"><span class="pre">close()</span></tt>.</p>
<div class="code java highlight-python"><div class="highlight"><pre>ConcurrentNavigableMap&lt;Integer,String&gt; map = db.getTreeMap(&quot;collectionName&quot;);

map.put(1,&quot;one&quot;);
map.put(2,&quot;two&quot;);
//map.keySet() is now [1,2] even before commit

db.commit();  //persist changes into disk

map.put(3,&quot;three&quot;);
//map.keySet() is now [1,2,3]
db.rollback(); //revert recent changes
//map.keySet() is now [1,2]

db.close();
</pre></div>
</div>
<p>One <tt class="docutils literal"><span class="pre">DB</span></tt> object represents single transactions. Examples above use
single global transaction, which is sufficient for some usages. MapDB
support concurrent transactions as well with full serializable
isolation, optimistic locking and MVCC snapshots. In that case we need
one extra factory which creates transactions: <tt class="docutils literal"><span class="pre">TxMaker</span></tt>. We use
<tt class="docutils literal"><span class="pre">DBMaker</span></tt> to create it, but instead of <tt class="docutils literal"><span class="pre">make()</span></tt> we call
<tt class="docutils literal"><span class="pre">makeTxMaker()</span></tt></p>
<div class="code java highlight-python"><div class="highlight"><pre>TxMaker txMaker = DBMaker
  .newMemoryDB()
  .makeTxMaker();
</pre></div>
</div>
<p>And <tt class="docutils literal"><span class="pre">TxMaker</span></tt> is than used to create multiple <tt class="docutils literal"><span class="pre">DB</span></tt> objects, each
representing single transaction:</p>
<div class="code java highlight-python"><div class="highlight"><pre>DB tx0 = txMaker.makeTx();
Map map0 = tx0.getTreeMap(&quot;testMap&quot;);
map0.put(0,&quot;zero&quot;);

DB tx1 = txMaker.makeTx();
Map map1 = tx1.getTreeMap(&quot;testMap&quot;);

DB tx2 = txMaker.makeTx();
Map map2 = tx1.getTreeMap(&quot;testMap&quot;);

map1.put(1,&quot;one&quot;);
map2.put(2,&quot;two&quot;);

//each map sees only its modifications,
//map1.keySet() contains [0,1]
//map2.keySet() contains [0,2]

//persist changes
tx1.commit();
tx2.commit();
// second commit fails  with write conflict, both maps share single BTree node,
// this does not happend on large maps with sufficent number of BTree nodes.
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="durability-versus-speed.html"
                        title="previous chapter">Durability and speed</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="what-for.html"
                        title="next chapter">What for?</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/doc/db-and-dbmaker.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="what-for.html" title="What for?"
             >next</a> |</li>
        <li class="right" >
          <a href="durability-versus-speed.html" title="Durability and speed"
             >previous</a> |</li>
        <li><a href="../index.html">MapDB</a> &raquo;</li>
          <li><a href="index.html" >MapDB documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Jan Kotek.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>