<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Unit testing multi-threaded code with Thread Weaver &mdash; MapDB</title>
    
    <link rel="stylesheet" href="../_static/sphinx13.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="MapDB" href="../index.html" />
  
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>
    <script type="text/javascript">
      // intelligent scrolling of the sidebar content
      $(window).scroll(function() {
        var sb = $('.sphinxsidebarwrapper');
        var win = $(window);
        var sbh = sb.height();
        var offset = $('.sphinxsidebar').position()['top'];
        var wintop = win.scrollTop();
        var winbot = wintop + win.innerHeight();
        var curtop = sb.position()['top'];
        var curbot = curtop + sbh;
        // does sidebar fit in window?
        if (sbh < win.innerHeight()) {
          // yes: easy case -- always keep at the top
          sb.css('top', $u.min([$u.max([0, wintop - offset - 10]),
                                $(document).height() - sbh - 200]));
        } else {
          // no: only scroll if top/bottom edge of sidebar is at
          // top/bottom edge of window
          if (curtop > wintop && curbot > winbot) {
            sb.css('top', $u.max([wintop - offset - 10, 0]));
          } else if (curtop < wintop && curbot < winbot) {
            sb.css('top', $u.min([winbot - sbh - offset - 20,
                                  $(document).height() - sbh - 200]));
          }
        }
      });
    </script>

<!-- google analytics-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42074659-1', 'auto');
  ga('send', 'pageview');

</script>

  
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.post-list-style-disc {list-style-type: disc;}
    ul.post-list-style-none {list-style-type: none;}
    ul.post-list-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body role="document">
<div class="pageheader">
  <ul>
    <li><a href="../index.html">Home</a></li>
    <li><a href="../doc/getting-started.html">Intro</a></li>
    <li><a href="../doc/index.html">Docs</a></li>
    <li><a href="/blog.html">Blog</a></li>
    <li><a href="https://github.com/jankotek/mapdb">Github</a></li>
  </ul>
  <div>
    <a href="../index.html">
      <img src="../_static/logo.png" alt="MapDB" />
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../index.html">Home</a>&nbsp;|</li>
        <li><a href="../contents.html">Documentation</a> &raquo;</li>
 
      </ul>
    </div>
    <div class="document">
    <div class="documentwrapper">
        <div class="bodywrapper">
            <div class="body" role="main">
                
  <div class="section" id="unit-testing-multi-threaded-code-with-thread-weaver">
<h1>Unit testing multi-threaded code with Thread Weaver<a class="headerlink" href="#unit-testing-multi-threaded-code-with-thread-weaver" title="Permalink to this headline">¶</a></h1>
<p>MapDB uses <a class="reference external" href="https://github.com/google/thread-weaver">Thread Weaver</a> for verifying multi-threaded code.
It was written by Google developers and has pretty impressive feature. Thread Weaver executes
code in multiple threads, adds breakpoints into each thread, and pauses thread  execution, until other thread progresses.
In theory that should catch all race conditions, because all possible combinations of delays are executed and verified.</p>
<p>If you are not familiar with Thread Weaver there is a <a class="reference external" href="https://code.google.com/p/thread-weaver/wiki/UsersGuide">User Guide</a>
and <a class="reference external" href="https://www.youtube.com/watch?v=FvH4RBn2gJ8">video presentation</a>.</p>
<p>Here is an example fow Thread Weaver is used with JUnit test. Source code of this example is
<a class="reference external" href="https://github.com/jankotek/thread-weaver/blob/master/src/test/java/examples/UniqueListTest.java">here</a>:</p>
<div class="code java highlight-python"><div class="highlight"><pre>public class UniqueListTest{

  private static final String HELLO = &quot;Hello&quot;;

  private volatile UniqueList&lt;String&gt; uniqueList;

  @Test(expected = RuntimeException.class)
  public void testPutIfAbsent() {
    System.out.printf(&quot;In testPutIfAbsent\n&quot;);
    // Create an AnnotatedTestRunner that will run the threaded tests defined in this
    // class. We want to test the behaviour of the private method &quot;putIfAbsentInternal&quot; so
    // we need to specify it by name using runner.setMethodOption()
    AnnotatedTestRunner runner = new AnnotatedTestRunner();
    HashSet&lt;String&gt; methods = new HashSet&lt;String&gt;();
    runner.setMethodOption(MethodOption.ALL_METHODS, methods);
    runner.setDebug(true);
    runner.runTests(this.getClass(), UniqueList.class);
  }

  @ThreadedBefore
  public void before() {
    // Set up a new UniqueList instance for the test
    uniqueList = new UniqueList&lt;String&gt;();
    System.out.printf(&quot;Created new list\n&quot;);
  }

  @ThreadedMain
  public void main() {
    // Add a new element to the list in the main test thread
    uniqueList.putIfAbsent(HELLO);
  }

  @ThreadedSecondary
  public void secondary() {
    // Add a new element to the list in the secondary test thread
    uniqueList.putIfAbsent(HELLO);
  }

  @ThreadedAfter
  public void after() {
    // If UniqueList is behaving correctly, it should only contain
    // a single copy of HELLO
    assertEquals(1, uniqueList.size());
    assertTrue(uniqueList.contains(HELLO));
  }
}
</pre></div>
</div>
<p>This example adds element into thread-unsafe list. Insertion should be performed only once,
but list is thread-unsafe and it will contain two element at end.</p>
<p>Thread Weaver annotations are straightforward. You need public class with no-argument constructor, which will be instantiated multiple times.
<code class="docutils literal"><span class="pre">&#64;ThreadedBefore</span></code> initializes the class before tests starts. Methods annotated by <code class="docutils literal"><span class="pre">&#64;ThreadedMain</span></code> and <code class="docutils literal"><span class="pre">&#64;ThreadedSecondary</span></code>
are executed in parallel in two threads. Code called from those two methods will be paused by breakpoints.
<code class="docutils literal"><span class="pre">&#64;ThreadedAfter</span></code> collects and verifies result, it should throw an exception if there is a mistake.</p>
<div class="section" id="out-fork-maven-repo">
<h2>Out fork &amp; Maven repo<a class="headerlink" href="#out-fork-maven-repo" title="Permalink to this headline">¶</a></h2>
<p>Thread Weaver stagnated a bit recently. Last commit is over one year old.
And <a class="reference external" href="http://mvnrepository.com/artifact/com.googlecode.thread-weaver/threadweaver">last release</a>
in Maven Central is three years old.</p>
<p>We are quite keen on using Thread Weaver. So we <a class="reference external" href="https://github.com/jankotek/thread-weaver">forked it</a>,
and made new <a class="reference external" href="http://mvnrepository.com/artifact/org.mapdb/thread-weaver/3.0.mapdb">Maven release</a>.
You can use our version with following Maven dependency:</p>
<div class="code xml highlight-python"><div class="highlight"><pre>&lt;dependency&gt;
        &lt;groupId&gt;org.mapdb&lt;/groupId&gt;
        &lt;artifactId&gt;thread-weaver&lt;/artifactId&gt;
        &lt;version&gt;3.0.mapdb&lt;/version&gt;
        &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
</pre></div>
</div>
<p>We made some minor tweaks. First we automated the build process and turned it into regular Maven project.
Original version is Ant based, requires you to download dependencies manually, and edit a few files before build.
Secondly we changed and simplified project layout, and included more unit tests.
And thirdly we made Thread Weaver Java8 compatible.</p>
</div>
<div class="section" id="practical-experience-with-thread-weaver">
<h2>Practical experience with Thread Weaver<a class="headerlink" href="#practical-experience-with-thread-weaver" title="Permalink to this headline">¶</a></h2>
<p>MapDB uses Thread Weaver to verify concurrent Maps, for example here
<a class="reference external" href="https://github.com/jankotek/mapdb/blob/mapdb3/mapdb/src/test/java/org/mapdb/HTreeMapWeaverTest.kt">is code for HTreeMap</a>.</p>
<p>We had mixed experience with Thread Weaver.
It was very valuable for initial design and proof-of-concept verification.
But once methods become larger and contained locks Thread Weaver failed.
We found following problems while using oit:</p>
<div class="section" id="false-positives">
<h3>False positives<a class="headerlink" href="#false-positives" title="Permalink to this headline">¶</a></h3>
<p>Thread Weaver reported some false positives. Methods which were thread-unsafe passed the test.
It is probably related to default timeouts. Test reported false positive after finishing in 1 second
With increased timeout, test ran for several seconds and  failed as expected.</p>
<p>But increased timeouts caused another problem once test was fixed.</p>
</div>
<div class="section" id="timeout-issues">
<h3>Timeout issues<a class="headerlink" href="#timeout-issues" title="Permalink to this headline">¶</a></h3>
<p>Default timeout in Thread Weaver is 1000 ms. That is not enough to execute more complex methods, so it is necessary
to increase timeout. However increased timeout caused some breakpoints to fail. It is probably a bug, since
that method were never even executed:</p>
<div class="code highlight-python"><div class="highlight"><pre>Caused by: com.google.testing.threadtester.TestTimeoutException: Did not reach Breakpoint(1) @ at beginning of copyAddKeyDir
        at com.google.testing.threadtester.AbstractBreakpoint.await(AbstractBreakpoint.java:186)
        at com.google.testing.threadtester.ObjectInstrumentationImpl.interleave(ObjectInstrumentationImpl.java:285)
</pre></div>
</div>
<p>To avoid this problem we changed breakpoint instrumentation. Instead of instrumenting all methods
with <code class="docutils literal"><span class="pre">MethodOption.ALL_METHODS</span></code>, we used <code class="docutils literal"><span class="pre">LISTED_METHODS</span></code> with white list of methods.</p>
</div>
<div class="section" id="no-recursive-instrumentation">
<h3>No recursive instrumentation<a class="headerlink" href="#no-recursive-instrumentation" title="Permalink to this headline">¶</a></h3>
<p>We found that Thread Weaver only adds breakpoint into methods directly called from <code class="docutils literal"><span class="pre">&#64;ThreadedMain</span></code> and <code class="docutils literal"><span class="pre">&#64;ThreadedSecondary</span></code>.
This proved great problem, since our <code class="docutils literal"><span class="pre">HTreeMap</span></code> first calls public <code class="docutils literal"><span class="pre">HTreeMap.put(key,value)</span></code> and from there
it calls private <code class="docutils literal"><span class="pre">HTreeMap.putInternal(key,value)</span></code>. But internal method which needs verification was not instrumented!</p>
<p>It is probably possible to make recursive instrumentation work. But we were unable to do it in a reliable way.</p>
<p>We had to bend our code and call <code class="docutils literal"><span class="pre">putInternal</span></code> directly from Unit tests. Some internal methods have to be public
or package protected, there is  extra logic etc...</p>
</div>
<div class="section" id="it-freezes">
<h3>It freezes<a class="headerlink" href="#it-freezes" title="Permalink to this headline">¶</a></h3>
<p>Some of the methods we verified had about 50 lines of code with loops.
In theory that is a few million combinations and should finish within a few hours.
However the test class was executed a few times, and than  Unit test just freezes (JVM has 0% CPU usage).</p>
<p>We added debug statements and <code class="docutils literal"><span class="pre">&#64;ThreadedAfter</span></code> verification method was executed only a few times (should be thousands or millions).
It is most likely related to Locks, because it only manifests once Locks are added into place.
Probably some sort of deadlock between breakpoints.</p>
</div>
</div>
<div class="section" id="alternatives">
<h2>Alternatives<a class="headerlink" href="#alternatives" title="Permalink to this headline">¶</a></h2>
<p>There are not many alternatives for Thread Weaver. The only automated solution is stress testing.
Code is executed several times in parallel, in hope that race condition will manifest itself.
That is quite difficult with low probability race conditions and corner cases.</p>
<p>Another practical problem is that issues manifest randomly in non-reproducible way.
It can be quite difficult to diagnose problem after it manifested in stress tests.</p>
<p>Good framework for concurrent stress testing is <a class="reference external" href="http://openjdk.java.net/projects/code-tools/jcstress/">JCStress</a>.
We are going to use this framework in MapDB soon.</p>
<p>Also MapDB we do one trick to increase chance that race condition will manifest itself.
We put several delay markers <code class="docutils literal"><span class="pre">//$DELAY$</span></code> into code, at places which might be prone to race condition.
Code preprocessor that replaces markers with actual <code class="docutils literal"><span class="pre">Thread.sleep(1)</span></code> delays, compiles the code and runs
concurrency stress test. Markers are not replace all at once, but in several combinations, to increase race condition chances.</p>
<p>This approach needs a lot of time to execute. Each delay marker adds another combination to test, and number of permutations grows exponentially.
We estimated it would take about 2 CPU years to stress test 20,000 lines of code in MapDB 2.0.
This is doable with cheap computing time on Amazon Spot Instances or similar cloud service.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>Thread Weaver has its quirks, but there is no alternative.
We found it to be gread aid for initial prototyping of concurrent code at early design stages.
Once prototype is tested as thread-safe, it can be refactored into more complex implementation.
We will use Thread Weaver again when designing concurrent Data Pump and Queues.</p>
<p>However Thread Weaver is not usable as automated verification tool.
It needs lot of baby sitting, does not work for complex code and does not produce reliable results.</p>
</div>
</div>

  <div class="section">
  
    


<div class="section">
  <span style="float: left;">
  
  Previous: 
  <a href="mapdb3.html">
    
    MapDB 3.0
  </a>
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
</div>

  
  
  </div>


                <script>

if(window.location.href.indexOf('/blog/')>-1){

document.write('<br><br><br><hr><br><div id="disqus_thread"></div>');


/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/
/*
var disqus_config = function () {
this.page.url = 'http://www.mapdb.org'; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = 'mapdb'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//mapdb.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();

}
</script>

            </div>
        </div>
    </div>

    <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../index.html">Home</a>&nbsp;|</li>
        <li><a href="../contents.html">Documentation</a> &raquo;</li>
 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, Jan Kotek.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>