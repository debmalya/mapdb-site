<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Unit testing multi-threaded code with Thread Weaver &mdash; MapDB</title>
    
    <link rel="stylesheet" href="../../_static/sphinx13.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="MapDB" href="../../" />
  
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>
    <script type="text/javascript">
      // intelligent scrolling of the sidebar content
      $(window).scroll(function() {
        var sb = $('.sphinxsidebarwrapper');
        var win = $(window);
        var sbh = sb.height();
        var offset = $('.sphinxsidebar').position()['top'];
        var wintop = win.scrollTop();
        var winbot = wintop + win.innerHeight();
        var curtop = sb.position()['top'];
        var curbot = curtop + sbh;
        // does sidebar fit in window?
        if (sbh < win.innerHeight()) {
          // yes: easy case -- always keep at the top
          sb.css('top', $u.min([$u.max([0, wintop - offset - 10]),
                                $(document).height() - sbh - 200]));
        } else {
          // no: only scroll if top/bottom edge of sidebar is at
          // top/bottom edge of window
          if (curtop > wintop && curbot > winbot) {
            sb.css('top', $u.max([wintop - offset - 10, 0]));
          } else if (curtop < wintop && curbot < winbot) {
            sb.css('top', $u.min([winbot - sbh - offset - 20,
                                  $(document).height() - sbh - 200]));
          }
        }
      });
    </script>

<!-- google analytics-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42074659-1', 'auto');
  ga('send', 'pageview');

</script>

  
  <link rel="alternate" type="application/atom+xml"  href="../../blog/atom.xml" title="MapDB Blog">
  
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body role="document">
<div class="pageheader">
  <ul>
    <li><a href="../../">Home</a></li>
    <li><a href="../../doc/quick-start/">Quick start</a></li>
    <li><a href="../../doc/">Docs</a></li>
    <li><a href="../../blog/">Blog</a></li>
      <li><a href="../../support/">Support</a></li>

      <li><a href="https://github.com/jankotek/mapdb">Github</a></li>
  </ul>
  <div>
    <a href="../../">
      <img src="../../_static/logo.png" alt="MapDB" />
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li><a href="../../">Home</a>&nbsp;|</li>
 
      </ul>
    </div>
<div class="sphinxsidebar" role="navigation" aria-label="main navigation">
    <div class="sphinxsidebarwrapper">
  <h3><a href="../../">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Unit testing multi-threaded code with Thread Weaver</a><ul>
<li><a class="reference internal" href="#our-fork-maven-release">Our fork &amp; Maven release</a></li>
<li><a class="reference internal" href="#practical-experience-with-thread-weaver">Practical experience with Thread Weaver</a><ul>
<li><a class="reference internal" href="#false-positives">False positives</a></li>
<li><a class="reference internal" href="#timeout-issues">Timeout issues</a></li>
<li><a class="reference internal" href="#no-recursive-instrumentation">No recursive instrumentation</a></li>
<li><a class="reference internal" href="#it-froze">It froze</a></li>
</ul>
</li>
<li><a class="reference internal" href="#alternatives">Alternatives</a></li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><div class="sitemap">
    <h3>Site Map</h3>
    <ul>
        <li><a href="/support/">Support</a></li>
        <li><a href="/blog/">Blog</a></li>
        <li><a href="/success/">Who is using MapDB</a></li>
        <li><a href="/benchmarks/">Benchmarks</a></li>
        <li><a href="/changelog/">Changelog</a></li>
        <li><a href="/credits/">Credits</a></li>
        <!--<li><a href="/careers/">Careers</a></li>-->

        <li><a href="/doc/">Documentation</a><ul>
            <li><a href="/doc/intro/">Intro</a></li>
            <li><a href="/doc/quick-start/">Quick start</a></li>
            <li><a href="/doc/db/">DB and DBMaker</a></li>
            <li><a href="/doc/htreemap/">HTreeMap</a></li>
            <li><a href="/doc/btreemap/">BTreeMap</a></li>
            <li><a href="/doc/sortedtablemap/">Sorted Table Map</a></li>
        </ul></li>
        <li><a href="/dokka/latest/mapdb/org.mapdb/">Javadoc</a></li>
    </ul>

    <h3>Links</h3>
    <ul>
        <li><a href="https://www.github.com/jankotek/mapdb/">Github</a>
        <li><a href="https://www.github.com/jankotek/mapdb/issues/">Issue tracker</a>
        <li><a href="https://groups.google.com/forum/#!forum/mapdb">Mail list</a></li>
        <li><a href="https://www.reddit.com/r/mapdb">Reddit forum</a></li>
        <li><a href="https://gitter.im/jankotek/mapdb">Gitter chat</a></li>
    </ul>
</div>
    </div>
</div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="unit-testing-multi-threaded-code-with-thread-weaver">
<h1>Unit testing multi-threaded code with Thread Weaver<a class="headerlink" href="#unit-testing-multi-threaded-code-with-thread-weaver" title="Permalink to this headline">¶</a></h1>
<p>MapDB uses <a class="reference external" href="https://github.com/google/thread-weaver">Thread Weaver</a> for verifying multi-threaded code.
It was written by Google developers and has pretty impressive features. Thread Weaver executes
code in multiple threads, adds breakpoints into each thread, and pauses thread  execution, until other thread progresses.
In theory that should catch all race conditions, because all possible combinations of delays are executed and verified.</p>
<p>If you are not familiar with Thread Weaver there is a <a class="reference external" href="https://code.google.com/p/thread-weaver/wiki/UsersGuide">User Guide</a>
and <a class="reference external" href="https://www.youtube.com/watch?v=FvH4RBn2gJ8">video presentation</a>.</p>
<p>Here is an example of how Thread Weaver is used with JUnit test. The source code of this example is
<a class="reference external" href="https://github.com/jankotek/thread-weaver/blob/master/src/test/java/examples/UniqueListTest.java">here</a>:</p>
<div class="code java highlight-default"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="k">class</span> <span class="nc">UniqueListTest</span><span class="p">{</span>

  <span class="n">private</span> <span class="n">static</span> <span class="n">final</span> <span class="n">String</span> <span class="n">HELLO</span> <span class="o">=</span> <span class="s2">&quot;Hello&quot;</span><span class="p">;</span>

  <span class="n">private</span> <span class="n">volatile</span> <span class="n">UniqueList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">uniqueList</span><span class="p">;</span>

  <span class="nd">@Test</span><span class="p">(</span><span class="n">expected</span> <span class="o">=</span> <span class="n">RuntimeException</span><span class="o">.</span><span class="n">class</span><span class="p">)</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">testPutIfAbsent</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">printf</span><span class="p">(</span><span class="s2">&quot;In testPutIfAbsent</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="o">//</span> <span class="n">Create</span> <span class="n">an</span> <span class="n">AnnotatedTestRunner</span> <span class="n">that</span> <span class="n">will</span> <span class="n">run</span> <span class="n">the</span> <span class="n">threaded</span> <span class="n">tests</span> <span class="n">defined</span> <span class="ow">in</span> <span class="n">this</span>
    <span class="o">//</span> <span class="n">class</span><span class="o">.</span> <span class="n">We</span> <span class="n">want</span> <span class="n">to</span> <span class="n">test</span> <span class="n">the</span> <span class="n">behaviour</span> <span class="n">of</span> <span class="n">the</span> <span class="n">private</span> <span class="n">method</span> <span class="s2">&quot;putIfAbsentInternal&quot;</span> <span class="n">so</span>
    <span class="o">//</span> <span class="n">we</span> <span class="n">need</span> <span class="n">to</span> <span class="n">specify</span> <span class="n">it</span> <span class="n">by</span> <span class="n">name</span> <span class="n">using</span> <span class="n">runner</span><span class="o">.</span><span class="n">setMethodOption</span><span class="p">()</span>
    <span class="n">AnnotatedTestRunner</span> <span class="n">runner</span> <span class="o">=</span> <span class="n">new</span> <span class="n">AnnotatedTestRunner</span><span class="p">();</span>
    <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">setMethodOption</span><span class="p">(</span><span class="n">MethodOption</span><span class="o">.</span><span class="n">ALL_METHODS</span><span class="p">,</span> <span class="n">methods</span><span class="p">);</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">setDebug</span><span class="p">(</span><span class="n">true</span><span class="p">);</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">runTests</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">getClass</span><span class="p">(),</span> <span class="n">UniqueList</span><span class="o">.</span><span class="n">class</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nd">@ThreadedBefore</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">before</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">up</span> <span class="n">a</span> <span class="n">new</span> <span class="n">UniqueList</span> <span class="n">instance</span> <span class="k">for</span> <span class="n">the</span> <span class="n">test</span>
    <span class="n">uniqueList</span> <span class="o">=</span> <span class="n">new</span> <span class="n">UniqueList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Created new list</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nd">@ThreadedMain</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">Add</span> <span class="n">a</span> <span class="n">new</span> <span class="n">element</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">list</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">main</span> <span class="n">test</span> <span class="n">thread</span>
    <span class="n">uniqueList</span><span class="o">.</span><span class="n">putIfAbsent</span><span class="p">(</span><span class="n">HELLO</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nd">@ThreadedSecondary</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">secondary</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">Add</span> <span class="n">a</span> <span class="n">new</span> <span class="n">element</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">list</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">secondary</span> <span class="n">test</span> <span class="n">thread</span>
    <span class="n">uniqueList</span><span class="o">.</span><span class="n">putIfAbsent</span><span class="p">(</span><span class="n">HELLO</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nd">@ThreadedAfter</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">after</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">If</span> <span class="n">UniqueList</span> <span class="ow">is</span> <span class="n">behaving</span> <span class="n">correctly</span><span class="p">,</span> <span class="n">it</span> <span class="n">should</span> <span class="n">only</span> <span class="n">contain</span>
    <span class="o">//</span> <span class="n">a</span> <span class="n">single</span> <span class="n">copy</span> <span class="n">of</span> <span class="n">HELLO</span>
    <span class="n">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">uniqueList</span><span class="o">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">assertTrue</span><span class="p">(</span><span class="n">uniqueList</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">HELLO</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This example adds an element into thread-unsafe list. Insertion should be performed only once,
but list is thread-unsafe. Parallel threads will insert the same element twice.</p>
<p>Thread Weaver annotations are straightforward. You need public class with no-argument constructor, which will be instantiated multiple times.
<code class="docutils literal"><span class="pre">&#64;ThreadedBefore</span></code> initializes the class before the tests start. Methods annotated by <code class="docutils literal"><span class="pre">&#64;ThreadedMain</span></code> and <code class="docutils literal"><span class="pre">&#64;ThreadedSecondary</span></code>
are executed in parallel in two threads. Code called from those two methods will be paused by breakpoints.
<code class="docutils literal"><span class="pre">&#64;ThreadedAfter</span></code> collects and verifies the result, and it should throw an exception if there is a mistake.</p>
<div class="section" id="our-fork-maven-release">
<h2>Our fork &amp; Maven release<a class="headerlink" href="#our-fork-maven-release" title="Permalink to this headline">¶</a></h2>
<p>Thread Weaver stagnated a bit recently. The most recent commit is over one year old,
and <a class="reference external" href="http://mvnrepository.com/artifact/com.googlecode.thread-weaver/threadweaver">last release</a>
in Maven Central is three years old.</p>
<p>We are quite keen on using Thread Weaver. So we <a class="reference external" href="https://github.com/jankotek/thread-weaver">forked it</a>,
and made a new <a class="reference external" href="http://mvnrepository.com/artifact/org.mapdb/thread-weaver/3.0.mapdb">Maven release</a>.
You can use our version with the following Maven dependency:</p>
<div class="code xml highlight-default"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="n">mapdb</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">thread</span><span class="o">-</span><span class="n">weaver</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="mf">3.0</span><span class="o">.</span><span class="n">mapdb</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">scope</span><span class="o">&gt;</span><span class="n">test</span><span class="o">&lt;/</span><span class="n">scope</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>We made some minor tweaks. First we automated the build process and turned it into a regular Maven project.
Original version is Ant based, requires you to download dependencies manually, and edit a few files before build.
Secondly we changed and simplified the project layout, and included more unit tests.
And thirdly we made Thread Weaver Java8 compatible.</p>
</div>
<div class="section" id="practical-experience-with-thread-weaver">
<h2>Practical experience with Thread Weaver<a class="headerlink" href="#practical-experience-with-thread-weaver" title="Permalink to this headline">¶</a></h2>
<p>MapDB uses Thread Weaver to verify concurrent Maps, for example here
<a class="reference external" href="https://github.com/jankotek/mapdb/blob/mapdb3/mapdb/src/test/java/org/mapdb/HTreeMapWeaverTest.kt">is code for HTreeMap</a>.</p>
<p>We had a mixed experience with Thread Weaver.
It was very valuable for initial design and proof-of-concept verification.
But once methods become larger and contained locks, Thread Weaver failed.
We found the following problems while using it:</p>
<div class="section" id="false-positives">
<h3>False positives<a class="headerlink" href="#false-positives" title="Permalink to this headline">¶</a></h3>
<p>Thread Weaver reported some false positives. Methods which were thread-unsafe passed the test.
It is probably related to default timeouts. The test reported false positive after finishing in 1 second.
We increased timeout, and the test ran for several seconds, and failed as expected.</p>
<p>But the increased timeout caused another problem once the test was fixed and methods become thread-safe.</p>
</div>
<div class="section" id="timeout-issues">
<h3>Timeout issues<a class="headerlink" href="#timeout-issues" title="Permalink to this headline">¶</a></h3>
<p>The default timeout in Thread Weaver is 1000 ms. That is not enough to execute more complex methods, so it is necessary
to increase timeout. However increased timeout caused some breakpoints to fail. It is probably a bug, since
that method was never even executed:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">Caused</span> <span class="n">by</span><span class="p">:</span> <span class="n">com</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">threadtester</span><span class="o">.</span><span class="n">TestTimeoutException</span><span class="p">:</span> <span class="n">Did</span> <span class="ow">not</span> <span class="n">reach</span> <span class="n">Breakpoint</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">@</span> <span class="n">at</span> <span class="n">beginning</span> <span class="n">of</span> <span class="n">copyAddKeyDir</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">threadtester</span><span class="o">.</span><span class="n">AbstractBreakpoint</span><span class="o">.</span><span class="k">await</span><span class="p">(</span><span class="n">AbstractBreakpoint</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">186</span><span class="p">)</span>
        <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="n">google</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">threadtester</span><span class="o">.</span><span class="n">ObjectInstrumentationImpl</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span><span class="n">ObjectInstrumentationImpl</span><span class="o">.</span><span class="n">java</span><span class="p">:</span><span class="mi">285</span><span class="p">)</span>
</pre></div>
</div>
<p>To avoid this problem we changed the breakpoint instrumentation. Instead of instrumenting all the methods
with <code class="docutils literal"><span class="pre">MethodOption.ALL_METHODS</span></code>, we used <code class="docutils literal"><span class="pre">LISTED_METHODS</span></code> with a white list of methods.</p>
</div>
<div class="section" id="no-recursive-instrumentation">
<h3>No recursive instrumentation<a class="headerlink" href="#no-recursive-instrumentation" title="Permalink to this headline">¶</a></h3>
<p>We found that Thread Weaver only adds a breakpoints into methods directly called from <code class="docutils literal"><span class="pre">&#64;ThreadedMain</span></code> and <code class="docutils literal"><span class="pre">&#64;ThreadedSecondary</span></code>.
This proved to be a great problem, since our <code class="docutils literal"><span class="pre">HTreeMap</span></code> first calls public <code class="docutils literal"><span class="pre">HTreeMap.put(key,value)</span></code> and from there
it calls private <code class="docutils literal"><span class="pre">HTreeMap.putInternal(key,value)</span></code>. But an internal method which needs verification was not instrumented!</p>
<p>It is probably possible to make recursive instrumentation work. But we were unable to do it in a reliable way.</p>
<p>We had to bend our code and call <code class="docutils literal"><span class="pre">putInternal</span></code> directly from Unit tests. Some internal methods have to be public
or package protected, there is  extra logic etc...</p>
</div>
<div class="section" id="it-froze">
<h3>It froze<a class="headerlink" href="#it-froze" title="Permalink to this headline">¶</a></h3>
<p>Some of the methods we verified had about 50 lines of code with loops.
In theory that is a few million combinations and should finish within a few hours.
However the test class was executed a few times, and than  Unit test just froze (JVM has 0% CPU usage).</p>
<p>We added debug statements and the <code class="docutils literal"><span class="pre">&#64;ThreadedAfter</span></code> verification method was executed only a few times (it should have been thousands or millions).
It is most likely related to Locks, because it only manifests once Locks are added into place.
Probably due to deadlock between breakpoints.</p>
</div>
</div>
<div class="section" id="alternatives">
<h2>Alternatives<a class="headerlink" href="#alternatives" title="Permalink to this headline">¶</a></h2>
<p>There are not many alternatives for Thread Weaver. The only automated solution is stress testing.
The code is executed several times in parallel, in hope that a race condition will manifest itself.
That is quite difficult with low probability race conditions and corner cases.</p>
<p>Another practical problem is that issues manifest randomly in a non-reproducible way.
It can be quite difficult to diagnose a problem after it is manifested in stress tests.</p>
<p>A good framework for concurrent stress testing is <a class="reference external" href="http://openjdk.java.net/projects/code-tools/jcstress/">JCStress</a>.
We are going to use this framework with MapDB soon.</p>
<p>With MapDB we do one trick to increase the chance that race condition will manifest itself.
We put several delay markers <code class="docutils literal"><span class="pre">//$DELAY$</span></code> into code, at places which might be prone to race condition.
The code preprocessor that replaces markers with actual <code class="docutils literal"><span class="pre">Thread.sleep(1)</span></code> delays, then compiles the code and finally runs
concurrency stress test. Markers are not replaced all at once, but in several combinations, to increase race condition chances.</p>
<p>This approach needs a lot of time to execute. Each delay marker adds into combinations to execute, and number of permutations grows exponentially.
We estimated it would take about 2 CPU years to stress test 20,000 lines of code in MapDB 2.0.
This is doable with some cheap computing time on Amazon Spot Instances or a similar cloud service.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>Thread Weaver has its quirks, but there is no alternative.
We found it to be a great aid for the initial prototyping of concurrent code at early design stages.
Once the prototype is tested as thread-safe, it can be refactored into more complex implementation.
We will use Thread Weaver again when designing concurrent Data Pump and Queues.</p>
<p>However Thread Weaver is not usable as automated verification tool.
It needs lot of baby sitting, does not work for complex code and does not produce reliable results.</p>
</div>
</div>

  <div class="section">
  
    


<div class="section">
  <span style="float: left;">
  
  Previous: 
  <a href="../mapdb3/">
    
    MapDB 3.0
  </a>
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
  Next: 
  <a href="../../changelog/#milestone-2-released-2016-02-12">
    3.0.0 Milestone 2 released (2016-02-12)
    
  </a>
  </span>
  
</div>

  
  
    <div class="section">
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'mapdb';
        var disqus_identifier = '/news/thread_weaver/';
        var disqus_title = 'Unit testing multi-threaded code with Thread Weaver';
        var disqus_url = 'http://www.mapdb.org/news/thread_weaver';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  
  </div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li><a href="../../">Home</a>&nbsp;|</li>
 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, jan.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
  </body>
</html>